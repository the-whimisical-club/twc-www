# Image Upload Error Codes

This document provides a reference for all error codes that may appear during image uploads. Error codes help diagnose issues, especially on mobile devices like iPhones.

## Server-Side Error Codes (UPLOAD_XXX)

### UPLOAD_001 - Unauthorized
**Status:** 401  
**Message:** User authentication required  
**Description:** The user is not authenticated or the session is invalid.  
**Solution:** 
- Ensure you are logged in
- Try logging out and logging back in
- Clear browser cookies and try again

### UPLOAD_002 - User Not Approved
**Status:** 403  
**Message:** User account is pending approval  
**Description:** The user account exists but has not been approved by an admin yet.  
**Solution:** 
- Wait for admin approval
- Contact an admin if you believe you should have access
- Check `/waitlist` page for approval status

### UPLOAD_003 - File Required
**Status:** 400  
**Message:** No file provided in request  
**Description:** The upload request was sent without a file attachment.  
**Solution:** 
- Ensure you selected a file before uploading
- Try selecting the file again
- Refresh the page and try again

### UPLOAD_004 - Worker Upload Failed
**Status:** 400-500  
**Message:** Cloudflare Worker upload failed  
**Description:** The image failed to upload to Cloudflare R2 storage. This can happen due to:
- File size exceeding 10MB limit
- Invalid file format
- Network connectivity issues
- Cloudflare Worker errors

**Solution:**
- Check file size (must be under 10MB)
- Ensure file is a valid image format (JPEG, PNG, GIF, WebP)
- Check your internet connection
- Try again after a few moments
- If problem persists, try a different image

### UPLOAD_005 - User Record Creation Failed
**Status:** 500  
**Message:** Could not create or retrieve user record in database  
**Description:** Failed to create or retrieve the user record in the database.  
**Solution:**
- Try again after a few moments
- Contact support if the issue persists
- Check if your account exists in the system

### UPLOAD_006 - Database Insert Failed
**Status:** 500  
**Message:** Database insert failed  
**Description:** The image was uploaded successfully but failed to save the URL to the database.  
**Solution:**
- The image may have been uploaded but not saved
- Try uploading again
- Contact support if the issue persists

### UPLOAD_007 - Unexpected Server Error
**Status:** 500  
**Message:** Unexpected server error occurred  
**Description:** An unexpected error occurred on the server during upload processing.  
**Solution:**
- Try again after a few moments
- Check if the issue persists with different images
- Contact support with the error code

### UPLOAD_008 - File Too Large
**Status:** 413  
**Message:** File exceeds 100MB limit  
**Description:** The uploaded file exceeds the 100MB size limit. Note that images are automatically compressed to WebP format, so original files can be larger than the final stored size. This error occurs when:
- Image file is extremely large (very high resolution photos)
- Raw image formats (RAW, TIFF) that are uncompressed
- Next.js body size limit was exceeded

**Solution:**
- Use a smaller image file
- Maximum allowed size: 100MB (original file)
- Images are automatically compressed to WebP, so you don't need to pre-compress
- On iPhone: Very high resolution photos may need to be resized first

### UPLOAD_009 - Request Processing Failed
**Status:** 400  
**Message:** Request processing failed  
**Description:** The server failed to process the upload request. This can happen when:
- Request body was truncated (exceeded size limit)
- FormData parsing failed
- Request format was invalid

**Solution:**
- Try uploading a smaller file
- Refresh the page and try again
- Check if your file is corrupted
- Try a different image file
- If problem persists, contact support

## Client-Side Error Codes (CLIENT_XXX)

### CLIENT_001 - Image Conversion Failed
**Message:** Failed to convert image. Please try a different image.  
**Description:** Failed to convert the image to WebP format. This commonly occurs on iOS devices when:
- The image format is not supported
- HEIC images fail to convert
- Canvas/WebP conversion is not supported by the browser

**Solution:**
- Try a different image
- On iPhone: Use a JPEG or PNG image instead of HEIC
- Convert the image to JPEG/PNG before uploading
- Update your browser to the latest version

### CLIENT_002 - Image Processing Failed
**Message:** Image processing failed  
**Description:** An error occurred while processing the image (e.g., during EXIF orientation correction or canvas operations).  
**Solution:**
- Try a different image
- Ensure the image is not corrupted
- Try resizing the image before uploading
- On iPhone: Convert HEIC to JPEG first

### CLIENT_003 - Image Load Failed
**Message:** Failed to load image. Please try a different image format.  
**Description:** The browser failed to load the selected image file. This can happen with:
- Corrupted image files
- Unsupported formats
- Very large images causing memory issues

**Solution:**
- Try a different image
- Ensure the image file is not corrupted
- Resize very large images before uploading
- Convert to a standard format (JPEG, PNG)

### CLIENT_004 - File Read Failed
**Message:** Failed to read file  
**Description:** The browser failed to read the selected file from disk.  
**Solution:**
- Ensure you have permission to access the file
- Try selecting the file again
- Check if the file is locked by another application
- Try a different file

### CLIENT_005 - Response Parse Failed
**Message:** Failed to parse response  
**Description:** The server response could not be parsed as JSON.  
**Solution:**
- Check your internet connection
- Try again after a few moments
- Refresh the page and try again

### CLIENT_006 - Upload Request Failed
**Message:** Upload failed  
**Description:** The upload request failed. This can be due to:
- Network connectivity issues
- Server errors
- Request timeout

**Solution:**
- Check your internet connection
- Try again after a few moments
- Ensure you're not on a restricted network
- Try using a different network connection

### CLIENT_007 - Network Error
**Message:** Network error  
**Description:** A network error occurred while sending the upload request.  
**Solution:**
- Check your internet connection
- Ensure you're connected to WiFi or cellular data
- Try again after a few moments
- Check if other websites are accessible

### CLIENT_008 - Upload Timeout
**Message:** Upload timeout - file may be too large  
**Description:** The upload request timed out after 60 seconds. This can happen with:
- Very large files
- Slow network connections
- Safari/iOS upload issues

**Solution:**
- Reduce the image file size (compress or resize)
- Check your network connection speed
- Try again on a faster network
- On iPhone: Convert HEIC to JPEG before uploading
- Try uploading a smaller image first to test

## Worker Error Codes (WORKER_XXX)

### WORKER_001 - Invalid Content Type
**Status:** 400  
**Message:** File type not supported  
**Description:** The uploaded file is not an allowed image format.  
**Solution:**
- Ensure file is JPEG, PNG, GIF, WebP, or SVG
- Convert the file to a supported format
- Check file extension matches file type

### WORKER_002 - File Too Large
**Status:** 400  
**Message:** File size exceeds maximum limit  
**Description:** The file exceeds the 100MB size limit. Note that original files can be up to 100MB and will be automatically compressed to WebP format for storage.  
**Solution:**
- Use a smaller image file
- Maximum allowed size: 100MB (original file, will be compressed)
- Images are automatically compressed, so you don't need to pre-compress

### WORKER_003 - R2 Storage Upload Failed
**Status:** 500  
**Message:** R2 storage upload failed  
**Description:** Failed to upload the image to Cloudflare R2 storage.  
**Solution:**
- Try again after a few moments
- Check your internet connection
- Contact support if the issue persists

## Safari/iOS-Specific Error Codes (SAFARI_XXX)

These error codes are specific to Safari on iOS and macOS. Safari has unique behaviors that can cause upload issues.

### SAFARI_001 - CORS Error
**Message:** Safari CORS error - authentication may have expired  
**Description:** Safari blocked the request due to Cross-Origin Resource Sharing (CORS) restrictions. This often happens when:
- Authentication cookies aren't being sent properly
- Session has expired
- Safari's privacy settings are blocking cookies

**Solution:**
- Refresh the page and log in again
- Check Safari's privacy settings (Settings → Safari → Prevent Cross-Site Tracking)
- Try disabling "Prevent Cross-Site Tracking" temporarily
- Clear Safari cookies and cache, then log in again
- Try using a different browser (Chrome, Firefox) to confirm it's Safari-specific

### SAFARI_002 - Session/Authentication Error
**Message:** Safari session error - please refresh and try again  
**Description:** Safari failed to send authentication cookies or the session expired. This is common on iOS Safari.

**Solution:**
- Refresh the page completely (pull down to refresh)
- Log out and log back in
- Clear Safari cookies for the site
- Ensure cookies are enabled in Safari settings
- Try again after a few moments
- Check if you're in Private Browsing mode (which blocks cookies)

### SAFARI_003 - Network Error (Safari-Specific)
**Message:** Safari network error - check connection  
**Description:** Safari failed to connect to the server, even with good network. This can be due to:
- Safari's aggressive request blocking
- Network security settings
- VPN or proxy issues

**Solution:**
- Check if other websites work in Safari
- Try disabling VPN if active
- Check Safari's network settings
- Try on a different network
- Restart Safari or the device

### SAFARI_004 - Upload Cancelled
**Message:** Safari upload cancelled  
**Description:** Safari cancelled or interrupted the upload. This can happen if:
- User switched apps
- Safari went to background
- Memory pressure caused Safari to kill the request

**Solution:**
- Keep Safari in foreground during upload
- Don't switch apps while uploading
- Close other apps to free memory
- Try uploading a smaller file first

### SAFARI_005 - Upload Timeout (Safari-Specific)
**Message:** Safari upload timeout  
**Description:** Upload timed out in Safari. Safari has stricter timeout limits than other browsers.

**Solution:**
- Reduce image file size
- Compress the image before uploading
- Try a lower resolution image
- Ensure stable network connection
- Close other Safari tabs

### SAFARI_006 - Memory Error
**Message:** Safari memory error - file too large  
**Description:** Safari ran out of memory processing the image. Safari on iOS has strict memory limits.

**Solution:**
- Use a smaller image file
- Reduce image resolution before uploading
- Close other apps and Safari tabs
- Convert HEIC to JPEG (JPEG uses less memory)
- Try uploading from a device with more available memory

### SAFARI_007 - FormData Error
**Message:** Safari FormData error  
**Description:** Safari failed to process the FormData. This can happen with:
- Corrupted file data
- Unsupported file format
- Safari's FormData implementation issues

**Solution:**
- Try a different image file
- Convert the image to a standard format (JPEG, PNG)
- Ensure the file isn't corrupted
- Try a smaller file size
- Update iOS to the latest version

### SAFARI_008 - Generic Safari Error
**Message:** Safari upload error  
**Description:** A Safari-specific error occurred that doesn't match other categories.

**Solution:**
- Check the specific error message for details
- Try refreshing the page
- Update Safari/iOS to the latest version
- Try using a different browser to confirm it's Safari-specific
- Report the error with the specific message

## Common iPhone-Specific Issues

### HEIC Format Issues
**Symptoms:** CLIENT_001, CLIENT_002, or CLIENT_003 errors  
**Cause:** iPhones default to HEIC format which may not convert properly  
**Solution:**
- Change iPhone camera settings to use JPEG format:
  - Settings → Camera → Formats → Most Compatible
- Or convert HEIC images before uploading

### Large Image Files
**Symptoms:** UPLOAD_004 errors, slow uploads, memory issues  
**Cause:** iPhone photos are often very high resolution (12MP+)  
**Solution:**
- Resize images before uploading
- Use a photo editing app to reduce resolution
- Ensure file size is under 10MB

### Orientation Issues
**Symptoms:** Images appear rotated incorrectly  
**Cause:** EXIF orientation data not handled properly  
**Solution:**
- The app should handle this automatically
- If images are still rotated, try rotating them manually before uploading

### Safari-Specific Issues
**Symptoms:** SAFARI_XXX errors, CLIENT_006, CLIENT_007  
**Cause:** Safari on iOS has unique limitations and behaviors:
- Stricter CORS enforcement
- Cookie/session handling differences
- Memory limitations
- FormData processing issues
- WebP and canvas operation limitations

**Solution:**
- Check for SAFARI_XXX error codes (more specific than CLIENT_XXX)
- Update iOS to the latest version
- Try using Chrome or Firefox on iOS to confirm it's Safari-specific
- The app includes Safari-specific error detection and fallbacks
- See individual SAFARI_XXX error codes above for specific solutions

## Troubleshooting Steps

1. **Check Error Code:** Note the specific error code displayed
2. **Review This Document:** Look up the error code above
3. **Try Basic Solutions:** 
   - Refresh the page
   - Try a different image
   - Check internet connection
4. **iPhone-Specific:** 
   - Convert HEIC to JPEG
   - Resize large images
   - Update iOS
5. **Contact Support:** If issues persist, provide:
   - Error code
   - Device/browser information
   - Steps to reproduce

## Additional Notes

- All images are converted to WebP format for storage (with JPEG fallback)
- Maximum file size: 10MB
- Supported formats: JPEG, PNG, GIF, WebP, SVG
- Images are organized in folders by username
- Upload progress is shown in the upload button

